#cloud-config
package_update: true
packages:
  - nginx

write_files:
  - path: /etc/nginx/sites-available/qbittorrent.home
    owner: root:root
    permissions: "0644"
    content: |
      server {
        listen 80;
        server_name qbittorrent.home;

        location / {
          proxy_pass http://192.168.0.102:8080;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
      }
  - path: /etc/nginx/sites-available/jellyfin.home
    owner: root:root
    permissions: "0644"
    content: |
      server {
        listen 80;
        server_name jellyfin.home;

        location / {
          proxy_pass http://192.168.0.102:8096;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_read_timeout 3600s;
          proxy_send_timeout 3600s;
        }
      }

runcmd:
  - [bash, -lc, "ln -sfn /etc/nginx/sites-available/qbittorrent.home /etc/nginx/sites-enabled/qbittorrent.home"]
  - [bash, -lc, "ln -sfn /etc/nginx/sites-available/jellyfin.home /etc/nginx/sites-enabled/jellyfin.home"]
  - [bash, -lc, "rm -f /etc/nginx/sites-enabled/default"]
  - [bash, -lc, "systemctl enable --now nginx"]
  - [bash, -lc, "nginx -t"]
  - [bash, -lc, "systemctl reload nginx"]
